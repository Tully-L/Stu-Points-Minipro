<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç”Ÿå·¥ä½œå° - ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- Vant 2 UIç»„ä»¶åº“ -->
    <link rel="stylesheet" href="https://unpkg.com/vant@2.12.54/lib/index.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7f8fa;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        
        .container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        .header {
            background: #1989fa;
            color: white;
            padding: 16px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .content {
            padding: 16px;
            padding-top: 80px;
            padding-bottom: 50px;
        }
        
        .upload-section {
            margin-bottom: 24px;
        }
        
        .form-item {
            margin-bottom: 16px;
        }
        
        .form-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #323233;
        }
        
        .submit-btn {
            width: 100%;
            margin-top: 24px;
        }
        
        .stats-card {
            background: #f7f8fa;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .stats-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .stats-item:last-child {
            margin-bottom: 0;
        }
        
        .status-approved {
            color: #07c160;
            font-weight: 500;
        }
        
        .status-rejected {
            color: #ee0a24;
            font-weight: 500;
        }
        
        .status-pending {
            color: #ff976a;
            font-weight: 500;
        }
        
        .van-cell-group {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .van-cell__label {
            color: #969799;
            font-size: 12px;
        }
        
        .file-preview {
            max-width: 100%;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .file-list {
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f2f3f5;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .file-icon {
            margin-right: 8px;
        }
        
        .van-uploader__preview-image {
            width: 80px;
            height: 80px;
        }
        
        .file-status {
            background: #f2f3f5;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 12px;
            color: #969799;
        }
        
        .file-status.has-files {
            color: #07c160;
        }
        
        .container {
            padding: 16px;
        }
        
        .tab-content {
            padding: 16px 0;
        }
        
        .point-card {
            background-color: #1989fa;
            color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .point-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            font-size: 16px;
        }
        
        .point-header span:last-child {
            font-size: 18px;
            font-weight: bold;
        }
        
        .point-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        
        .point-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50%;
            margin-bottom: 12px;
        }
        
        .point-item span:first-child {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .point-item span:last-child {
            font-size: 16px;
            font-weight: bold;
        }
        
        .action-row {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            color: #ffffff;
        }
        
        .request-link-btn {
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            padding: 0 16px;
            height: 36px;
            line-height: 34px;
        }
    </style>
</head>
<body>
    <div id="app">
        <van-nav-bar
            title="å­¦ç”Ÿå·¥ä½œå°"
            left-text="è¿”å›"
            left-arrow
            fixed
            placeholder
        >
            <template #right>
                <van-icon name="bars" size="18" />
            </template>
        </van-nav-bar>
        
        <div class="container">
            <van-row>
                <van-col span="24">
                    <div class="point-card">
                        <div class="point-header">
                            <span>ä¸ªäººä¿¡æ¯</span>
                            <span id="studentNameDisplay" onclick="showNameSettingDialog()" style="cursor: pointer;">æœªè®¾ç½®å§“å</span>
                        </div>
                        <div class="point-details">
                            <div class="point-item">
                                <span>è´¦å·ID</span>
                                <span id="studentAccountId">S12345</span>
                            </div>
                            <div class="point-item">
                                <span>æ€»ç§¯åˆ†</span>
                                <span id="totalPoints">0</span>
                            </div>
                            <div class="point-item">
                                <span>æœ¬æœˆç§¯åˆ†</span>
                                <span id="monthlyPoints">0</span>
                            </div>
                            <div class="point-item">
                                <span>æäº¤æ¬¡æ•°</span>
                                <span id="submissionCount">0</span>
                            </div>
                        </div>
                        <div class="action-row">
                            <van-button size="small" type="primary" id="requestLinkBtn" class="request-link-btn">è¯·æ±‚å…³è”å®¶é•¿</van-button>
                        </div>
                    </div>
                </van-col>
            </van-row>
            
            <van-tabs v-model="activeTab">
                <van-tab title="æäº¤ä½œä¸š">
                    <div class="tab-content">
                        <van-cell-group inset>
                            <div id="subjectPicker"></div>
                            <div id="typePicker"></div>
                            
                            <van-cell title="ä¸Šä¼ æ–‡ä»¶">
                                <div id="fileUploadContainer">
                                    <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.mp4" style="display:none;">
                                    <button id="selectFilesBtn" class="van-button van-button--primary van-button--small">é€‰æ‹©æ–‡ä»¶</button>
                                    <span id="fileStatus" class="file-status">æœªä¸Šä¼ æ–‡ä»¶</span>
                                    <div id="previewContainer" class="preview-container"></div>
                                </div>
                            </van-cell>
                            
                            <div id="remarkField"></div>
                        </van-cell-group>
                        
                        <div id="submitBtn" class="submit-btn-container"></div>
                    </div>
                </van-tab>
                <van-tab title="å†å²è®°å½•">
                    <div class="tab-content">
                        <div id="historyList" class="history-list"></div>
                    </div>
                </van-tab>
                <van-tab title="è®¾ç½®">
                    <div class="tab-content">
                        <van-cell-group inset title="å®¶é•¿å…³è”">
                            <div id="parentLinkSection">
                                <van-cell-group>
                                    <van-cell title="å…³è”çŠ¶æ€">
                                        <template #right-icon>
                                            <van-tag v-if="linkedParent" type="success">å·²å…³è”</van-tag>
                                            <van-tag v-else-if="linkPending" type="primary">å¾…ç¡®è®¤</van-tag>
                                            <van-tag v-else type="warning">æœªå…³è”</van-tag>
                                        </template>
                                    </van-cell>
                                    <van-cell v-if="linkedParent" :title="'å…³è”å®¶é•¿: ' + linkedParent.name">
                                        <template #label>
                                            <span>å®¶é•¿è´¦å·: {{ linkedParent.id }}</span>
                                        </template>
                                    </van-cell>
                                    <van-cell v-if="linkPending" :title="'ç­‰å¾…ç¡®è®¤: ' + pendingParentName">
                                        <template #label>
                                            <span>è¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…å®¶é•¿ç¡®è®¤</span>
                                        </template>
                                    </van-cell>
                                </van-cell-group>
                                
                                <div style="padding: 16px;">
                                    <van-button type="primary" block @click="requestLink">è¯·æ±‚å…³è”å®¶é•¿</van-button>
                                </div>
                            </div>
                        </van-cell-group>
                        
                        <van-cell-group inset title="ä¸ªäººä¿¡æ¯" style="margin-top: 16px;">
                            <van-field
                                v-model="studentName"
                                label="å§“å"
                                placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
                            />
                            <div style="padding: 16px;">
                                <van-button type="primary" block @click="saveStudentInfo">ä¿å­˜å§“å</van-button>
                            </div>
                        </van-cell-group>
                    </div>
                </van-tab>
            </van-tabs>
        </div>
    </div>
    
    <!-- Vue 2.x -->
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
    
    <!-- Vant JavaScript -->
    <script src="https://unpkg.com/vant@2.12.54/lib/vant.min.js"></script>
    
    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const appData = {
            selectedSubject: null,
            selectedType: null,
            uploadedFiles: [],
            activeTab: 0,
            studentInfo: {
                id: '',
                name: '',
                accountId: ''
            }
        };
        
        // ç§‘ç›®é€‰é¡¹
        const subjects = [
            { text: 'æ•°å­¦', value: 'math' },
            { text: 'è¯­æ–‡', value: 'chinese' },
            { text: 'è‹±è¯­', value: 'english' },
            { text: 'ç‰©ç†', value: 'physics' },
            { text: 'åŒ–å­¦', value: 'chemistry' },
            { text: 'ç”Ÿç‰©', value: 'biology' },
            { text: 'å†å²', value: 'history' },
            { text: 'åœ°ç†', value: 'geography' },
            { text: 'æ”¿æ²»', value: 'politics' }
        ];
        
        // å†…å®¹ç±»å‹é€‰é¡¹
        const contentTypes = [
            { text: 'ä½œä¸š', value: 'homework' },
            { text: 'è€ƒè¯•', value: 'exam' },
            { text: 'ç»ƒä¹ ', value: 'practice' },
            { text: 'å­¦ä¹ è§†é¢‘', value: 'video' },
            { text: 'ç¬”è®°', value: 'notes' }
        ];
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initComponents();
            setupFileUpload();
            loadUserData();
            updateFileStatus();
            initSettingsTab();
            initStudentAccount();
        });
        
        // åˆå§‹åŒ–å­¦ç”Ÿè´¦å·
        function initStudentAccount() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è´¦å·ï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»º
            let studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
            
            if (!studentInfo.accountId) {
                // ç”Ÿæˆéšæœºè´¦å·ID (æ ¼å¼: S + 5ä½æ•°å­—)
                const accountId = 'S' + Math.floor(10000 + Math.random() * 90000);
                studentInfo.accountId = accountId;
                
                // é»˜è®¤å§“åè®¾ç½®ä¸ºè´¦å·ID
                if (!studentInfo.name) {
                    studentInfo.name = accountId;
                }
                
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
            }
            
            // å¦‚æœæ²¡æœ‰è®¾ç½®å§“åï¼Œé»˜è®¤ä½¿ç”¨è´¦å·ID
            if (!studentInfo.name) {
                studentInfo.name = studentInfo.accountId;
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
            }
            
            // æ›´æ–°æ˜¾ç¤º
            const accountIdEl = document.getElementById('studentAccountId');
            if (accountIdEl) accountIdEl.textContent = studentInfo.accountId;
            
            const nameDisplayEl = document.getElementById('studentNameDisplay');
            if (nameDisplayEl) nameDisplayEl.textContent = studentInfo.name;
            
            // è®¾ç½®è¯·æ±‚å…³è”æŒ‰é’®äº‹ä»¶
            const requestLinkBtn = document.getElementById('requestLinkBtn');
            if (requestLinkBtn) {
                requestLinkBtn.addEventListener('click', function() {
                    showLinkRequestDialog();
                });
            }
            
            // å°†å­¦ç”Ÿä¿¡æ¯æ·»åŠ åˆ°å…¨å±€å­¦ç”Ÿä¿¡æ¯åˆ—è¡¨ä¸­
            const allStudentInfos = JSON.parse(sessionStorage.getItem('allStudentInfos') || '[]');
            const existingIndex = allStudentInfos.findIndex(s => s.accountId === studentInfo.accountId);
            
            if (existingIndex === -1) {
                allStudentInfos.push(studentInfo);
            } else {
                allStudentInfos[existingIndex] = studentInfo;
            }
            
            sessionStorage.setItem('allStudentInfos', JSON.stringify(allStudentInfos));
            
            // æ£€æŸ¥å…³è”çŠ¶æ€
            checkAndUpdateLinkStatus(studentInfo);
        }
        
        // æ£€æŸ¥å¹¶æ›´æ–°å…³è”çŠ¶æ€
        function checkAndUpdateLinkStatus(studentInfo) {
            // æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦å·²å…³è”å®¶é•¿
            const relatedStudents = JSON.parse(sessionStorage.getItem('relatedStudents') || '[]');
            const relatedRecord = relatedStudents.find(student => student.id === studentInfo.accountId);
            
            if (relatedRecord) {
                // å·²å…³è”ï¼Œä¿å­˜å…³è”ä¿¡æ¯
                studentInfo.linkedParent = {
                    id: relatedRecord.parentId,
                    name: relatedRecord.parentName || 'å®¶é•¿'
                };
                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å¾…ç¡®è®¤çŠ¶æ€
                const studentLinkStatus = JSON.parse(sessionStorage.getItem('studentLinkStatus') || '{}');
                if (studentLinkStatus.pendingParentId) {
                    delete studentLinkStatus.pendingParentId;
                    delete studentLinkStatus.pendingParentName;
                    sessionStorage.setItem('studentLinkStatus', JSON.stringify(studentLinkStatus));
                }
            }
        }
        
        // æ˜¾ç¤ºå…³è”è¯·æ±‚å¯¹è¯æ¡†
        function showLinkRequestDialog() {
            // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å§“å
            const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
            if (!studentInfo.name) {
                vant.Dialog.alert({
                    title: 'è¯·å…ˆè®¾ç½®å§“å',
                    message: 'è¯·åœ¨è®¾ç½®é¡µé¢ä¸­è®¾ç½®æ‚¨çš„å§“ååå†è¯·æ±‚å…³è”',
                }).then(() => {
                    // åˆ‡æ¢åˆ°è®¾ç½®é€‰é¡¹å¡
                    const settingsTab = document.querySelector('.van-tabs__nav .van-tab:nth-child(3)');
                    if (settingsTab) {
                        settingsTab.click();
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°æ ‡ç­¾ï¼Œç›´æ¥æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                        showNameSettingDialog();
                    }
                });
                return;
            }
            
            vant.Dialog.confirm({
                title: 'è¯·æ±‚å…³è”å®¶é•¿',
                message: 'è¯·è¾“å…¥å®¶é•¿æä¾›çš„å…³è”ç æˆ–å®¶é•¿è´¦å·',
                showCancelButton: true,
                confirmButtonText: 'æäº¤è¯·æ±‚',
                beforeClose: (action, done) => {
                    if (action === 'confirm') {
                        const input = document.querySelector('#linkCodeInput');
                        if (input) {
                            submitLinkRequest(input.value, done);
                        } else {
                            done();
                            vant.Toast('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    } else {
                        done();
                    }
                }
            }).then(() => {
                // ç¡®è®¤åçš„æ“ä½œ
            }).catch(() => {
                // å–æ¶ˆåçš„æ“ä½œ
            });
            
            // åˆ›å»ºè¾“å…¥æ¡†
            setTimeout(() => {
                const dialogContent = document.querySelector('.van-dialog__content');
                if (dialogContent) {
                    const inputHtml = `
                        <div style="padding: 0 16px;">
                            <input id="linkCodeInput" class="van-field__control" 
                                   placeholder="è¯·è¾“å…¥6ä½å…³è”ç æˆ–å®¶é•¿è´¦å·" 
                                   style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ebedf0; border-radius: 4px;">
                        </div>
                    `;
                    dialogContent.innerHTML = inputHtml + dialogContent.innerHTML;
                }
            }, 10);
        }
        
        // æ˜¾ç¤ºåå­—è®¾ç½®å¯¹è¯æ¡†
        function showNameSettingDialog() {
            const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
            const defaultName = studentInfo.name || studentInfo.accountId || '';
            
            vant.Dialog.confirm({
                title: 'è®¾ç½®å§“å',
                message: 'è¯·è¾“å…¥æ‚¨çš„å§“åï¼ˆè‡³å°‘1ä¸ªå­—ç¬¦ï¼‰',
                showCancelButton: true,
                confirmButtonText: 'ä¿å­˜',
                beforeClose: (action, done) => {
                    if (action === 'confirm') {
                        const input = document.querySelector('#nameInput');
                        if (input && input.value && input.value.trim().length > 0) {
                            // ä¿å­˜å§“å
                            const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
                            studentInfo.name = input.value.trim();
                            sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                            
                            // æ›´æ–°æ˜¾ç¤º
                            const nameDisplay = document.getElementById('studentNameDisplay');
                            if (nameDisplay) {
                                nameDisplay.textContent = studentInfo.name;
                            }
                            
                            // æ›´æ–°è®¾ç½®é¡µé¢ä¸­çš„å§“åè¾“å…¥æ¡†
                            const settingsSection = document.querySelector('#parentLinkSection');
                            if (settingsSection && settingsSection.__vue__) {
                                settingsSection.__vue__.studentName = studentInfo.name;
                            }
                            
                            done();
                            vant.Toast.success('å§“åè®¾ç½®æˆåŠŸ');
                        } else {
                            vant.Toast('è¯·è¾“å…¥æœ‰æ•ˆçš„å§“å');
                            return false; // é˜»æ­¢å¯¹è¯æ¡†å…³é—­
                        }
                    } else {
                        done();
                    }
                }
            });
            
            // åˆ›å»ºè¾“å…¥æ¡†
            setTimeout(() => {
                const dialogContent = document.querySelector('.van-dialog__content');
                if (dialogContent) {
                    const inputHtml = `
                        <div style="padding: 0 16px;">
                            <input id="nameInput" class="van-field__control" 
                                   placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" 
                                   value="${defaultName}"
                                   style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ebedf0; border-radius: 4px;">
                        </div>
                    `;
                    dialogContent.innerHTML = inputHtml + dialogContent.innerHTML;
                }
            }, 10);
        }
        
        // æäº¤å…³è”è¯·æ±‚
        function submitLinkRequest(input, done) {
            if (!input) {
                vant.Toast('è¯·è¾“å…¥å…³è”ç æˆ–å®¶é•¿è´¦å·');
                return false;
            }
            
            const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
            
            // åˆ¤æ–­è¾“å…¥æ˜¯å…³è”ç è¿˜æ˜¯è´¦å·
            if (input.length === 6 && /^\d+$/.test(input)) {
                // å…³è”ç å¤„ç†
                const linkCodeData = JSON.parse(sessionStorage.getItem('linkCode') || '{}');
                const now = new Date().getTime();
                
                if (!linkCodeData.code || linkCodeData.code !== input) {
                    vant.Toast('å…³è”ç æ— æ•ˆ');
                    return false;
                }
                
                if (linkCodeData.expiry < now) {
                    vant.Toast('å…³è”ç å·²è¿‡æœŸ');
                    return false;
                }
                
                // è·å–å®¶é•¿ä¿¡æ¯
                const parentInfo = getParentInfoById(linkCodeData.parentId);
                
                // åˆ›å»ºå…³è”è¯·æ±‚
                createLinkRequest(studentInfo, linkCodeData.parentId, parentInfo.name || 'æœªçŸ¥å®¶é•¿');
                done();
                return true;
            } else if (input.startsWith('P') && input.length === 6) {
                // å®¶é•¿è´¦å·å¤„ç†
                const parentId = input;
                
                // è·å–å®¶é•¿ä¿¡æ¯
                const parentInfo = getParentInfoById(parentId);
                
                if (!parentInfo) {
                    vant.Toast('æœªæ‰¾åˆ°è¯¥å®¶é•¿è´¦å·ï¼Œè¯·ç¡®è®¤è¾“å…¥æ­£ç¡®');
                    return false;
                }
                
                createLinkRequest(studentInfo, parentId, parentInfo.name || 'æœªçŸ¥å®¶é•¿');
                done();
                return true;
            } else {
                vant.Toast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…³è”ç æˆ–å®¶é•¿è´¦å·(På¼€å¤´)');
                return false;
            }
        }
        
        // è·å–å®¶é•¿ä¿¡æ¯
        function getParentInfoById(parentId) {
            // ä»parentInfoä¸­è·å–
            const allParentInfos = JSON.parse(sessionStorage.getItem('allParentInfos') || '[]');
            let parentInfo = allParentInfos.find(p => p.accountId === parentId);
            
            // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„å®¶é•¿ä¿¡æ¯
            if (!parentInfo) {
                parentInfo = {
                    accountId: parentId,
                    name: 'å®¶é•¿' + parentId.substring(1) // ä½¿ç”¨è´¦å·IDå5ä½ä½œä¸ºé»˜è®¤åç§°
                };
                
                // ä¿å­˜åˆ°å…¨å±€å®¶é•¿ä¿¡æ¯åˆ—è¡¨
                allParentInfos.push(parentInfo);
                sessionStorage.setItem('allParentInfos', JSON.stringify(allParentInfos));
            }
            
            return parentInfo;
        }
        
        // åˆ›å»ºå…³è”è¯·æ±‚
        function createLinkRequest(studentInfo, parentId, parentName) {
            const linkRequest = {
                studentId: studentInfo.accountId,
                studentName: studentInfo.name || 'æœªå‘½åå­¦ç”Ÿ',
                parentId: parentId,
                parentName: parentName,
                requestTime: new Date().getTime()
            };
            
            // ä¿å­˜å…³è”è¯·æ±‚
            const requests = JSON.parse(sessionStorage.getItem('linkRequests') || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè¯·æ±‚
            const existingRequest = requests.find(req => 
                req.studentId === linkRequest.studentId && 
                req.parentId === linkRequest.parentId
            );
            
            if (existingRequest) {
                vant.Toast('æ‚¨å·²å‘é€è¿‡å…³è”è¯·æ±‚ï¼Œè¯·ç­‰å¾…å®¶é•¿ç¡®è®¤');
                return;
            }
            
            requests.push(linkRequest);
            sessionStorage.setItem('linkRequests', JSON.stringify(requests));
            
            // æ›´æ–°çŠ¶æ€
            const studentLinkStatus = {
                pendingParentId: parentId,
                pendingParentName: parentName,
                requestTime: new Date().getTime()
            };
            sessionStorage.setItem('studentLinkStatus', JSON.stringify(studentLinkStatus));
            
            vant.Toast.success(`å…³è”è¯·æ±‚å·²å‘é€ç»™ ${parentName}ï¼Œç­‰å¾…ç¡®è®¤`);
        }
        
        // åˆå§‹åŒ–è®¾ç½®é€‰é¡¹å¡
        function initSettingsTab() {
            new Vue({
                el: '#parentLinkSection',
                data: {
                    linkError: '',
                    linkedParent: null,
                    linkPending: false,
                    studentName: '',
                    pendingParentName: ''
                },
                created() {
                    // åŠ è½½å­¦ç”Ÿä¿¡æ¯
                    const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
                    this.studentName = studentInfo.name || studentInfo.accountId || '';
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å…³è”å®¶é•¿
                    this.checkParentLink();
                },
                methods: {
                    requestLink() {
                        // æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å§“å
                        if (!this.studentName || this.studentName.trim().length === 0) {
                            vant.Toast('è¯·å…ˆè®¾ç½®æ‚¨çš„å§“å');
                            return;
                        }
                        
                        // æ˜¾ç¤ºå…³è”è¯·æ±‚å¯¹è¯æ¡†
                        showLinkRequestDialog();
                    },
                    checkParentLink() {
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤çš„è¯·æ±‚
                        const studentLinkStatus = JSON.parse(sessionStorage.getItem('studentLinkStatus') || '{}');
                        
                        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å…³è”è®°å½•
                        const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
                        const relatedStudents = JSON.parse(sessionStorage.getItem('relatedStudents') || '[]');
                        
                        // æŸ¥æ‰¾å…³è”è®°å½•
                        const relatedRecord = relatedStudents.find(student => 
                            student.id === studentInfo.accountId
                        );
                        
                        if (relatedRecord) {
                            // å·²å…³è”ï¼Œç›´æ¥æ˜¾ç¤ºå…³è”ä¿¡æ¯
                            this.linkedParent = {
                                id: relatedRecord.parentId,
                                name: relatedRecord.parentName || 'å®¶é•¿'
                            };
                            this.linkPending = false;
                            
                            // ä¿å­˜å…³è”çŠ¶æ€
                            if (!studentInfo.linkedParent) {
                                studentInfo.linkedParent = this.linkedParent;
                                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                            }
                            
                            return;
                        }
                        
                        // å¦‚æœæ²¡æœ‰å…³è”è®°å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¾…ç¡®è®¤è¯·æ±‚
                        if (studentLinkStatus.pendingParentId) {
                            this.linkPending = true;
                            this.pendingParentName = studentLinkStatus.pendingParentName || 'æœªçŸ¥å®¶é•¿';
                            
                            // æ£€æŸ¥æ˜¯å¦å·²è¢«ç¡®è®¤
                            const isConfirmed = relatedStudents.some(student => 
                                student.id === studentInfo.accountId
                            );
                            
                            if (isConfirmed) {
                                // å…³è”å·²ç¡®è®¤
                                this.linkedParent = {
                                    id: studentLinkStatus.pendingParentId,
                                    name: studentLinkStatus.pendingParentName || 'å®¶é•¿'
                                };
                                this.linkPending = false;
                                
                                // ä¿å­˜å…³è”çŠ¶æ€åˆ°å­¦ç”Ÿä¿¡æ¯ä¸­
                                studentInfo.linkedParent = this.linkedParent;
                                sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                                
                                // æ¸…é™¤å¾…ç¡®è®¤çŠ¶æ€
                                delete studentLinkStatus.pendingParentId;
                                delete studentLinkStatus.pendingParentName;
                                sessionStorage.setItem('studentLinkStatus', JSON.stringify(studentLinkStatus));
                            }
                        } else {
                            // æ£€æŸ¥å­¦ç”Ÿä¿¡æ¯ä¸­æ˜¯å¦å·²ä¿å­˜å…³è”çŠ¶æ€
                            if (studentInfo.linkedParent) {
                                this.linkedParent = studentInfo.linkedParent;
                                this.linkPending = false;
                            }
                        }
                    },
                    saveStudentInfo() {
                        if (!this.studentName || this.studentName.trim().length === 0) {
                            vant.Toast('è¯·è¾“å…¥æœ‰æ•ˆçš„å§“å');
                            return;
                        }
                        
                        // ä¿å­˜å­¦ç”Ÿä¿¡æ¯
                        const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
                        studentInfo.name = this.studentName.trim();
                        sessionStorage.setItem('studentInfo', JSON.stringify(studentInfo));
                        
                        // æ›´æ–°æ˜¾ç¤º
                        const nameDisplayEl = document.getElementById('studentNameDisplay');
                        if (nameDisplayEl) nameDisplayEl.textContent = this.studentName;
                        
                        // æ›´æ–°å…¨å±€å­¦ç”Ÿä¿¡æ¯åˆ—è¡¨
                        const allStudentInfos = JSON.parse(sessionStorage.getItem('allStudentInfos') || '[]');
                        const existingIndex = allStudentInfos.findIndex(s => s.accountId === studentInfo.accountId);
                        
                        if (existingIndex === -1) {
                            allStudentInfos.push(studentInfo);
                        } else {
                            allStudentInfos[existingIndex] = studentInfo;
                        }
                        
                        sessionStorage.setItem('allStudentInfos', JSON.stringify(allStudentInfos));
                        
                        vant.Toast.success('å§“åå·²ä¿å­˜');
                    }
                }
            });
        }
        
        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const selectFilesBtn = document.getElementById('selectFilesBtn');
            const previewContainer = document.getElementById('previewContainer');
            
            // ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
            selectFilesBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–
            fileInput.addEventListener('change', function(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                
                // æ¸…ç©ºé¢„è§ˆåŒºåŸŸ
                previewContainer.innerHTML = '';
                
                // æ¸…ç©ºå·²ä¸Šä¼ æ–‡ä»¶æ•°ç»„
                appData.uploadedFiles = [];
                
                // å¤„ç†æ¯ä¸ªé€‰æ‹©çš„æ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    const fileName = file.name.toLowerCase();
                    const isValidType = fileName.endsWith('.jpg') || 
                                       fileName.endsWith('.jpeg') || 
                                       fileName.endsWith('.png') || 
                                       fileName.endsWith('.mp4');
                    
                    if (!isValidType) {
                        vant.Toast('åªæ”¯æŒ .jpg, .jpeg, .png, .mp4 æ ¼å¼çš„æ–‡ä»¶');
                        continue;
                    }
                    
                    // åˆ›å»ºæ–‡ä»¶é¢„è§ˆ
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    // åˆ›å»ºé¢„è§ˆå†…å®¹
                    const isImage = file.type.indexOf('image') !== -1;
                    const isVideo = file.type.indexOf('video') !== -1;
                    
                    // åˆ›å»ºæ–‡ä»¶è¯»å–å™¨æ¥è·å–æ–‡ä»¶å†…å®¹
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const fileContent = e.target.result;
                        
                        // åˆ›å»ºé¢„è§ˆå…ƒç´ 
                        if (isImage) {
                            const img = document.createElement('img');
                            img.src = fileContent;
                            img.className = 'preview-image';
                            previewItem.appendChild(img);
                        } else if (isVideo) {
                            const video = document.createElement('video');
                            video.src = fileContent;
                            video.className = 'preview-video';
                            video.controls = true;
                            previewItem.appendChild(video);
                        } else {
                            const icon = document.createElement('div');
                            icon.className = 'file-icon';
                            icon.textContent = 'ğŸ“„';
                            previewItem.appendChild(icon);
                        }
                        
                        // åˆ›å»ºæ–‡ä»¶åæ˜¾ç¤º
                        const nameElement = document.createElement('div');
                        nameElement.className = 'file-name';
                        nameElement.textContent = file.name.length > 15 ? 
                            file.name.substring(0, 12) + '...' : file.name;
                        previewItem.appendChild(nameElement);
                        
                        // åˆ›å»ºåˆ é™¤æŒ‰é’®
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'Ã—';
                        deleteBtn.addEventListener('click', function() {
                            // ä»é¢„è§ˆä¸­ç§»é™¤
                            previewContainer.removeChild(previewItem);
                            
                            // ä»ä¸Šä¼ æ–‡ä»¶æ•°ç»„ä¸­ç§»é™¤
                            const fileIndex = appData.uploadedFiles.findIndex(f => f.name === file.name);
                            if (fileIndex !== -1) {
                                appData.uploadedFiles.splice(fileIndex, 1);
                            }
                            
                            // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                            updateFileStatus();
                            
                            console.log('åˆ é™¤åçš„æ–‡ä»¶åˆ—è¡¨:', appData.uploadedFiles);
                        });
                        previewItem.appendChild(deleteBtn);
                        
                        // æ·»åŠ åˆ°é¢„è§ˆå®¹å™¨
                        previewContainer.appendChild(previewItem);
                        
                        // ä¿å­˜æ–‡ä»¶ä¿¡æ¯åˆ°ä¸Šä¼ æ–‡ä»¶æ•°ç»„
                        appData.uploadedFiles.push({
                            name: file.name,
                            type: file.type,
                            isImage: isImage,
                            isVideo: isVideo,
                            content: fileContent,
                            url: fileContent
                        });
                        
                        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                        updateFileStatus();
                        
                        console.log('å½“å‰æ–‡ä»¶åˆ—è¡¨:', appData.uploadedFiles);
                    };
                    
                    // è¯»å–æ–‡ä»¶å†…å®¹
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
        function updateFileStatus() {
            const fileStatus = document.getElementById('fileStatus');
            if (appData.uploadedFiles && appData.uploadedFiles.length > 0) {
                fileStatus.textContent = `å·²ä¸Šä¼  ${appData.uploadedFiles.length} ä¸ªæ–‡ä»¶`;
                fileStatus.classList.add('has-files');
            } else {
                fileStatus.textContent = 'æœªä¸Šä¼ æ–‡ä»¶';
                fileStatus.classList.remove('has-files');
            }
        }
        
        // åˆå§‹åŒ–ç»„ä»¶
        function initComponents() {
            // ç§‘ç›®é€‰æ‹©å™¨
            const SubjectPicker = new Vue({
                el: '#subjectPicker',
                data: {
                    showPicker: false,
                    columns: subjects,
                    selectedText: 'è¯·é€‰æ‹©ç§‘ç›®'
                },
                methods: {
                    onConfirm(value) {
                        appData.selectedSubject = value;
                        this.selectedText = `å·²é€‰æ‹©: ${value.text}`;
                        this.showPicker = false;
                    },
                    onCancel() {
                        this.showPicker = false;
                    },
                    showSubjectPicker() {
                        this.showPicker = true;
                    }
                },
                template: `
                    <div>
                        <div class="van-cell van-cell--clickable" @click="showSubjectPicker">
                            <div class="van-cell__title">{{selectedText}}</div>
                            <div class="van-cell__right-icon">
                                <i class="van-icon van-icon-arrow"></i>
                            </div>
                        </div>
                        <van-popup v-model="showPicker" position="bottom">
                            <van-picker
                                show-toolbar
                                :columns="columns"
                                @confirm="onConfirm"
                                @cancel="onCancel"
                            />
                        </van-popup>
                    </div>
                `
            });
            
            // å†…å®¹ç±»å‹é€‰æ‹©å™¨
            const TypePicker = new Vue({
                el: '#typePicker',
                data: {
                    showPicker: false,
                    columns: contentTypes,
                    selectedText: 'è¯·é€‰æ‹©å†…å®¹ç±»å‹'
                },
                methods: {
                    onConfirm(value) {
                        appData.selectedType = value;
                        this.selectedText = `å·²é€‰æ‹©: ${value.text}`;
                        this.showPicker = false;
                    },
                    onCancel() {
                        this.showPicker = false;
                    },
                    showTypePicker() {
                        this.showPicker = true;
                    }
                },
                template: `
                    <div>
                        <div class="van-cell van-cell--clickable" @click="showTypePicker">
                            <div class="van-cell__title">{{selectedText}}</div>
                            <div class="van-cell__right-icon">
                                <i class="van-icon van-icon-arrow"></i>
                            </div>
                        </div>
                        <van-popup v-model="showPicker" position="bottom">
                            <van-picker
                                show-toolbar
                                :columns="columns"
                                @confirm="onConfirm"
                                @cancel="onCancel"
                            />
                        </van-popup>
                    </div>
                `
            });
            
            // å¤‡æ³¨è¾“å…¥æ¡†
            const RemarkField = new Vue({
                el: '#remarkField',
                data: {
                    remark: ''
                },
                methods: {
                    getValue() {
                        return this.remark;
                    },
                    setValue(value) {
                        this.remark = value;
                    }
                },
                template: `
                    <van-field
                        v-model="remark"
                        type="textarea"
                        placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"
                        rows="3"
                        maxlength="200"
                        show-word-limit
                    />
                `
            });
            
            // æäº¤æŒ‰é’® - ä½¿ç”¨æ™®é€šæŒ‰é’®æ›¿ä»£Vueç»„ä»¶
            const submitBtn = document.createElement('button');
            submitBtn.className = 'van-button van-button--primary van-button--large';
            submitBtn.style.width = '100%';
            submitBtn.style.marginTop = '16px';
            submitBtn.innerHTML = 'æäº¤ä½œä¸š';
            
            // è°ƒè¯•æŒ‰é’®
            const debugBtn = document.createElement('button');
            debugBtn.className = 'van-button van-button--default van-button--small';
            debugBtn.style.marginTop = '8px';
            debugBtn.style.width = '100%';
            debugBtn.innerHTML = 'æ£€æŸ¥æ–‡ä»¶çŠ¶æ€';
            debugBtn.onclick = function(e) {
                e.preventDefault();
                console.log('å½“å‰æ–‡ä»¶åˆ—è¡¨:', appData.uploadedFiles);
                vant.Toast(`å½“å‰å·²ä¸Šä¼  ${appData.uploadedFiles.length} ä¸ªæ–‡ä»¶`);
                updateFileStatus();
            };
            
            // ç›´æ¥æŒ‚è½½åˆ°DOM
            const submitContainer = document.getElementById('submitBtn');
            submitContainer.appendChild(submitBtn);
            submitContainer.appendChild(debugBtn);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            submitBtn.addEventListener('click', function(e) {
                e.preventDefault(); // é˜²æ­¢è¡¨å•æäº¤
                
                console.log("æäº¤æŒ‰é’®è¢«ç‚¹å‡»");
                console.log("å½“å‰é€‰æ‹©çš„ç§‘ç›®:", appData.selectedSubject);
                console.log("å½“å‰é€‰æ‹©çš„ç±»å‹:", appData.selectedType);
                console.log("å½“å‰ä¸Šä¼ çš„æ–‡ä»¶:", appData.uploadedFiles);
                
                try {
                    // éªŒè¯è¡¨å•
                    if (!appData.selectedSubject || !appData.selectedSubject.value) {
                        console.error('ç§‘ç›®æœªé€‰æ‹©');
                        vant.Toast('è¯·é€‰æ‹©ç§‘ç›®');
                        return;
                    }
                    
                    if (!appData.selectedType || !appData.selectedType.value) {
                        console.error('å†…å®¹ç±»å‹æœªé€‰æ‹©');
                        vant.Toast('è¯·é€‰æ‹©å†…å®¹ç±»å‹');
                        return;
                    }
                    
                    // éªŒè¯æ–‡ä»¶ä¸Šä¼ 
                    if (!appData.uploadedFiles || appData.uploadedFiles.length === 0) {
                        console.error('æœªä¸Šä¼ æ–‡ä»¶', appData.uploadedFiles);
                        vant.Toast('è¯·ä¸Šä¼ è‡³å°‘ä¸€ä¸ªæ–‡ä»¶');
                        return;
                    }
                    
                    // è·å–å­¦ç”Ÿä¿¡æ¯
                    const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
                    if (!studentInfo.name) {
                        vant.Dialog.confirm({
                            title: 'è®¾ç½®å§“å',
                            message: 'è¯·å…ˆè®¾ç½®æ‚¨çš„å§“ååå†æäº¤ä½œä¸š',
                            confirmButtonText: 'å»è®¾ç½®',
                            showCancelButton: false
                        }).then(() => {
                            showNameSettingDialog();
                        });
                        return;
                    }
                    
                    // è·å–å¤‡æ³¨ - ç›´æ¥ä»DOMè·å–
                    const remarkField = document.querySelector('#remarkField .van-field__control');
                    const remark = remarkField ? remarkField.value : '';
                    console.log('è·å–åˆ°çš„å¤‡æ³¨:', remark);
                    
                    // åˆ›å»ºä¸€ä¸ªæäº¤è®°å½• - ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„ç§‘ç›®å’Œç±»å‹
                    const submissionData = {
                        id: 'sub_' + new Date().getTime() + '_' + Math.floor(Math.random() * 1000),
                        subject: appData.selectedSubject.text,
                        type: appData.selectedType.text,
                        remark: remark || '',
                        status: 'pending',
                        timestamp: new Date().getTime(),
                        files: JSON.parse(JSON.stringify(appData.uploadedFiles)),
                        studentId: studentInfo.accountId || '',
                        studentName: studentInfo.name || 'æœªå‘½åå­¦ç”Ÿ'
                    };
                    
                    console.log('æäº¤æ•°æ®:', submissionData);
                    
                    // ç›´æ¥ä½¿ç”¨æ•°ç»„å­˜å‚¨åˆ°sessionStorage
                    let submissions = [];
                    try {
                        const existingSubmissions = sessionStorage.getItem('submissions');
                        if (existingSubmissions) {
                            submissions = JSON.parse(existingSubmissions);
                        }
                    } catch (error) {
                        console.error('è¯»å–æäº¤è®°å½•å¤±è´¥:', error);
                    }
                    
                    // æ·»åŠ æ–°è®°å½•
                    submissions.unshift(submissionData);
                    
                    // ä¿å­˜å›sessionStorage
                    sessionStorage.setItem('submissions', JSON.stringify(submissions));
                    console.log('å·²ä¿å­˜åˆ°sessionStorage');
                    
                    // æ˜¾ç¤ºæäº¤æˆåŠŸæ¶ˆæ¯
                    vant.Toast.success({
                        message: 'æäº¤æˆåŠŸï¼ç­‰å¾…å®¶é•¿å®¡æ ¸',
                        position: 'bottom'
                    });
                    
                    // é‡ç½®è¡¨å•
                    resetForm();
                    
                    // åˆ·æ–°å†å²è®°å½•
                    loadSubmissions();
                    
                    // æ›´æ–°ç»Ÿè®¡æ•°æ®
                    updateStats();
                } catch (error) {
                    console.error('æäº¤è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    vant.Toast.fail('æäº¤å¤±è´¥: ' + error.message);
                }
            });
            
            // åˆå§‹åŠ è½½å†å²è®°å½•
            loadSubmissions();
            
            // ä¿å­˜ç»„ä»¶å¼•ç”¨
            window.SubjectPicker = SubjectPicker;
            window.TypePicker = TypePicker;
            window.RemarkField = RemarkField;
        }
        
        // é‡ç½®è¡¨å•
        function resetForm() {
            appData.selectedSubject = null;
            appData.selectedType = null;
            appData.uploadedFiles = [];
            
            // é‡ç½®æ˜¾ç¤º
            if (window.SubjectPicker) {
                window.SubjectPicker.selectedText = 'è¯·é€‰æ‹©ç§‘ç›®';
            }
            
            if (window.TypePicker) {
                window.TypePicker.selectedText = 'è¯·é€‰æ‹©å†…å®¹ç±»å‹';
            }
            
            // æ¸…ç©ºæ–‡ä»¶é¢„è§ˆ
            const previewContainer = document.getElementById('previewContainer');
            if (previewContainer) {
                previewContainer.innerHTML = '';
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // æ¸…ç©ºå¤‡æ³¨
            if (window.RemarkField) {
                window.RemarkField.remark = '';
            }
            
            // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
            updateFileStatus();
            
            console.log('è¡¨å•å·²é‡ç½®');
        }
        
        // åŠ è½½ç”¨æˆ·æ•°æ®
        function loadUserData() {
            updateStats();
            
            // åŠ è½½å­¦ç”Ÿä¿¡æ¯
            const studentInfo = JSON.parse(sessionStorage.getItem('studentInfo') || '{}');
            appData.studentInfo = studentInfo;
        }
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            try {
                const submissions = JSON.parse(sessionStorage.getItem('submissions') || '[]');
                const approvedSubmissions = submissions.filter(item => item.status === 'approved');
                
                // è®¡ç®—æ€»ç§¯åˆ†
                const totalPoints = approvedSubmissions.reduce((sum, item) => sum + (item.points || 0), 0);
                
                // è®¡ç®—æœ¬æœˆç§¯åˆ†
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const monthlyPoints = approvedSubmissions.reduce((sum, item) => {
                    const date = new Date(item.timestamp);
                    if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                        return sum + (item.points || 0);
                    }
                    return sum;
                }, 0);
                
                // æäº¤æ¬¡æ•°
                const submissionCount = submissions.length;
                
                // æ›´æ–°æ˜¾ç¤º - æ·»åŠ å®‰å…¨æ£€æŸ¥
                const totalPointsEl = document.getElementById('totalPoints');
                if (totalPointsEl) totalPointsEl.textContent = totalPoints;
                
                const monthlyPointsEl = document.getElementById('monthlyPoints');
                if (monthlyPointsEl) monthlyPointsEl.textContent = monthlyPoints;
                
                const submissionCountEl = document.getElementById('submissionCount');
                if (submissionCountEl) submissionCountEl.textContent = submissionCount;
            } catch (error) {
                console.error('æ›´æ–°ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD HH:MM æ ¼å¼
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // ä»sessionStorageåŠ è½½æäº¤è®°å½•
        function loadSubmissions() {
            console.log('ä»sessionStorageåŠ è½½æäº¤è®°å½•...');
            
            try {
                const historyList = document.getElementById('historyList');
                if (!historyList) {
                    console.error('æ‰¾ä¸åˆ°historyListå…ƒç´ ');
                    return;
                }
                
                // è·å–æäº¤è®°å½•
                let submissions = [];
                const existingSubmissions = sessionStorage.getItem('submissions');
                
                if (existingSubmissions) {
                    submissions = JSON.parse(existingSubmissions);
                    console.log('ä»sessionStorageè·å–çš„æäº¤è®°å½•:', submissions);
                } else {
                    console.log('sessionStorageä¸­æ²¡æœ‰æäº¤è®°å½•');
                }
                
                // æ¸²æŸ“æäº¤è®°å½•
                renderSubmissions(submissions);
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats();
            } catch (error) {
                console.error('åŠ è½½æäº¤è®°å½•å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“æäº¤è®°å½•
        function renderSubmissions(submissions) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            if (submissions.length === 0) {
                historyList.innerHTML = '<div class="van-empty"><p>æš‚æ— æäº¤è®°å½•</p></div>';
                return;
            }
            
            let html = '';
            for (const item of submissions) {
                const subject = item.subject;
                const type = item.type;
                const status = item.status || 'pending';
                const points = item.points || 0;
                const submitTime = formatDate(item.timestamp);
                const reviewerRole = item.reviewerRole || '';
                
                let statusText = 'å¾…å®¡æ ¸';
                let statusClass = 'status-pending';
                
                if (status === 'approved') {
                    statusText = 'å·²é€šè¿‡ +' + points + 'åˆ†';
                    statusClass = 'status-approved';
                } else if (status === 'rejected') {
                    statusText = 'å·²æ‰“å›';
                    statusClass = 'status-rejected';
                }
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                let fileInfo = '';
                if (item.files && item.files.length > 0) {
                    fileInfo = `
                        <div class="van-cell__label">
                            å·²æäº¤ ${item.files.length} ä¸ªæ–‡ä»¶
                        </div>
                    `;
                }
                
                // æ˜¾ç¤ºè¯„åˆ†è€…ä¿¡æ¯
                let reviewerInfo = '';
                if (reviewerRole && (status === 'approved' || status === 'rejected')) {
                    reviewerInfo = `
                        <div class="van-cell__label" style="color: #1989fa;">
                            è¯„åˆ†è€…ï¼š${reviewerRole}
                        </div>
                    `;
                }
                
                html += `
                    <div class="van-cell-group" style="margin-bottom: 8px;">
                        <div class="van-cell">
                            <div class="van-cell__title">
                                <div>${subject} - ${type}</div>
                                <div class="van-cell__label">${submitTime}</div>
                                ${fileInfo}
                                ${reviewerInfo}
                            </div>
                            <div class="van-cell__value">
                                <span class="${statusClass}">${statusText}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            historyList.innerHTML = html;
            console.log('æäº¤è®°å½•æ¸²æŸ“å®Œæˆ');
        }
    </script>
</body>
</html> 